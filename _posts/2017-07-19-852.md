---
layout: post
published: true
title: 3x3矩阵如何实现完整的3D变换
tags:
- 移动开发
- 图形渲染
---

Android 中的 Matrix 类是一个 3x3 矩阵，之前一直不太明白为啥 2D 变换不直接用 3x2 矩阵，用 3x3 矩阵不是白白浪费内存吗？直到后来发现 Android 中的 Matrix 竟然是可以表示3D变换的，具体可以参考这个例子：[Android中利用Camera与Matrix实现3D效果详解](http://www.jianshu.com/p/34e0fe5f9e31)。然而印象中表示 3D 变换的矩阵至少也得是 4x3 矩阵，出于好奇就研究了一下 Android 的这个 3x3 矩阵是如何实现3D变换的。

先来复习一下 OpenGL 里标准的 4x4 矩阵：

```
[a, b, c, d]
[e, f, g, h]
[i, j, k, l]
[m, n, o, p]
```
然后我们有一个顶点：

```
[x, y, z, w]
```

原始顶点里的 x,y,z 分量表示三维坐标，相信都不用解释了。w 分量为 1 时表示这是一个点坐标，如果 w 为 0 则表示这是一个方向。由于我们要表示点坐标，那这里的 w 就是一个定值 1。根据：矩阵 x 顶点 = 变换后的顶点。得到变换后顶点 [x1, y1, z1, w1] 各分量的公式：

```
x1 = ax + by + cz + dw
y1 = ex + fy + gz + hw
z1 = ix + jy + kz + lw
w1 = mx + ny + oz + pw
```

因为变换后还是一个顶点，所以可以知道变换后的顶点里的 w1 也必须是定值 1，那么这个 4x4 矩阵的最后一行 [m,n,o,p] 实际上是没有作用的，通常恒定为 [0,0,0,1]。所以一个 4x3 矩阵就足以表达完整的 3D 顶点变换:

```
[a, b, c, d]
[d, f, g, h]
[i, j, k, l]
```
再代入 w 的定值 1 得到简化后转换公式：

```
x1 = ax + by + cz + d
y1 = ex + fy + gz + h
z1 = ix + jy + kz + l
```

而 Android 中只用了 3x3 矩阵就表达了完整的 3D 变换，不难推理出肯定是省略了 4x3 矩阵中的某一列，具体是哪一列呢？

再观察一下不难发现，Android 中的 Matrix 的输入顶点其实都是 2D 的坐标点。也就坐标点的 z 轴始终为定值 0. 代入公式就可以发现倒数第二列 c,g,k 结果恒定为 0。因此正是这列可以被忽略。最终 Android 里的 Matrix 每个值跟 OpenGL 4x4 矩阵的对应关系是： 

```
[a, b, d]
[e, f, h]
[i, j, l]
```
根据以上的对应关系，相信大家已经知道怎么把 Android 里的 3x3 矩阵转换为 OpenGL 里的 4x4 矩阵了吧。对应的，一个 2D 坐标点 [x, y] 变换为 3D 坐标点 [x1, y1, z1] 的公式为：

```
x1 = ax + by + d
y1 = ex + fy + h
z1 = ix + jy + l
```
总结：如果输入目标是一个 2D 的坐标点，只需要 3x3 矩阵就可以把它完整变换到 3D 空间里，而对一个 3D 的坐标点，则至少需要 4x3 矩阵才可以正确变换。


